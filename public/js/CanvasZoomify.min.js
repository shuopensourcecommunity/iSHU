!function(t,e,i,s){"use strict"
function o(t,e,i){this.config=$.extend({},o.DEFAULTS,i,"object"==typeof i&&i),this.isDebug=this.config.isDebug,this.isDebug&&console.log("CanvasZoomify Debug: ",this.isDebug),this.$element=$(t),this.$canvas=$("<canvas></canvas>"),this.$canvas.appendTo(this.$element),this.canvas=this.$canvas[0],this.canvas.width=this.config.width,this.canvas.height=this.config.height,this.context=this.canvas.getContext("2d"),this.tileManager=new n(this,e),this.imageLevel=0,this.touchEventManager=new Hammer(this.canvas),this.touchEventManager.get("pan").set({direction:Hammer.DIRECTION_ALL}),this.touchEventManager.get("pinch").set({enable:!0}),_.each(["tap","doubletap","press","swipe"],function(t){this.touchEventManager.get(t).set({enable:!1})}.bind(this)),this.mouseState={isMouseDown:!1,mouseMoveLastX:null,mouseMoveLastY:null},this.touchState={touchPanLastX:null,touchPanLastY:null,touchPinchLastScale:null},this.init(),this.config.afterInit(),this.trigger("cz_update"),this.trigger("cz_clear"),this.trigger("cz_repaint")}function n(t,e){this.canvasZoomify=t,this.config=e,this.tilesList=this.config.tiles,this.levelValues=this.config.levelValues,this.rowsPerLevel=this.config.rowsPerLevel,this.colsPerLevel=this.config.colsPerLevel,this.isDebug=this.config.isDebug||!1,this.tilesCache={},this._rowsAtLevel=_.map(this.levelValues,function(t){return t*this.rowsPerLevel}.bind(this)),this._colsAtLevel=_.map(this.levelValues,function(t){return t*this.colsPerLevel}.bind(this)),this._tileWidthAtLevel=_.map(this.levelValues,function(t){return-1}),this._tileHeightAtLevel=_.map(this.levelValues,function(t){return-1}),this._tileSuggestionCache=function(){return _.map(this.levelValues,function(t){return _.map(_.range(t*this.rowsPerLevel*t*this.colsPerLevel),function(t){return-1})}.bind(this))}.bind(this)(),this._getTileSuggestion=function(t,e,i){return this._tileSuggestionCache[t][e*this._colsAtLevel[t]+i]},this._setTileSuggestion=function(t,e,i,s){this._tileSuggestionCache[t][e*this._colsAtLevel[t]+i]=s},this._tileOnLoadHandler=function(t,e,i){var s=this._getTileSuggestion(t,e,i)
if(!(s>=t)){var o=function(t,e,i){if(!(0>=t)){var s=Math.floor(e/2),n=Math.floor(i/2),a=this._getTileSuggestion(t-1,s,n),h=[this._getTileSuggestion(t,2*s,2*n),this._getTileSuggestion(t,2*s,2*n+1),this._getTileSuggestion(t,2*s+1,2*n),this._getTileSuggestion(t,2*s+1,2*n+1)],l=_.min(h)
l!=a&&(this._setTileSuggestion(t-1,s,n,l),o(t-1,s,n))}}.bind(this)
this._tileSuggestionCache[t][e*this._colsAtLevel[t]+i]=t,o(t,e,i)}},this.checkTile=function(t,e,i){var s=""+t+"-"+e+"-"+i,o=this.tilesCache[s]
return o?0==o?null:o:(this.loadTileFromDisk(t,e,i),this.tilesCache[s]=0,null)},this.getTile=function(t,e,i,s){var o=""+t+"-"+e+"-"+i,n=this.tilesCache[o]
return n&&0!=n?(s&&s(n,t,e,i),n):n&&0==n?null:(this.loadTileFromDisk(t,e,i,s),this.tilesCache[o]=0,null)},this.loadTileFromDisk=function(t,e,i,s){this.isDebug&&console.log("loadTileFromDisk: ",t,e,i)
var o=new Image
o.onload=function(){-1==this._tileWidthAtLevel[t]&&(this._tileWidthAtLevel[t]=o.width,this._tileHeightAtLevel[t]=o.height)
var n=""+t+"-"+e+"-"+i
this.tilesCache[n]=o,this._tileOnLoadHandler(t,e,i),s&&s(o,t,e,i)}.bind(this),o.src=this.tilesList[t][e][i]},this.drawTile=function(t,e,i,s){1==this.isDebug&&t.strokeRect(i,s,i+e.width,s+e.height),t.drawImage(e,i,s)},this.drawTileScaled=function(t,e,i,s,o){var n=e.width*o,a=e.height*o
this.isDebug&&t.strokeRect(i,s,n,a),t.drawImage(e,i,s,n,a)},this.drawTileAtLevel=function(t,e,i,s,o,n,a,h,l){this.isDebug&&console.log(sprintf("drawTileAtLevel: %d,%d,%d,%d,%d,%d,%d,%f",e,i,s,o,n,a,h,l))
for(var c=i;o>c;++c)for(var u=s;n>u;++u)this.getTile(e,c,u,function(e,i,s,o){var n=e.width*l*o,c=e.height*l*s
this.drawTileScaled(t,e,n+a,c+h,l)}.bind(this))}}o.DEFAULTS={isDebug:!1,width:640,height:480,offsetX:0,offsetY:0,scale:1,scaleStep:1.1,scaleMax:16,afterInit:function(){},onUpdate:function(t){},onClear:function(t){},onRepaint:function(t){},onPanstart:function(t){},onPanmove:function(t){},onPinchstart:function(t){},onPinch:function(t){},onMousedown:function(t){},onMouseup:function(t){},onMousemove:function(t){},onMousewheel:function(t){},onDOMMouseScroll:function(t){}},o.EVENTS={cz_update:"custom",cz_clear:"custom",cz_repaint:"custom",panstart:"multitouch",panmove:"multitouch",pinchstart:"multitouch",pinch:"multitouch",mousedown:"mouse",mouseup:"mouse",mousemove:"mouse",mousewheel:"mouse",DOMMouseScroll:"mouse"},o.prototype.trigger=function(t){this.isDebug&&console.log("trigger: ",t),$(this).trigger.apply($(this),arguments)},o.prototype._mousePosX=function(t){var e=0
return t.layerX||0===t.layerX?e=t.layerX-this.canvas.offsetLeft:(t.offsetX||0===t.offsetX)&&(e=t.offsetX),e},o.prototype._mousePosY=function(t){var e=0
return t.layerY||0===t.layerY?e=t.layerY-this.canvas.offsetTop:(t.offsetY||0===t.offsetY)&&(e=t.offsetY),e},o._getHandlerName=function(t){var e="on"+t.charAt(0).toUpperCase()+t.slice(1)
return this.isDebug&&console.log("_getHandlerName",e),e},o._getDefaultHandlerName=function(t){var e=this._getHandlerName(t)+"_default"
return this.isDebug&&console.log("_getDefaultHandlerName: ",e),e},o.prototype._initEvents=function(){_.each(o.EVENTS,function(t,e,i){console.log("_initEvents each: ",e)
var t=o.EVENTS[e]
if("custom"==t)$(this).on(e,this._getInitEvents_custom(e))
else if("multitouch"==t)this.touchEventManager.on(e,this._getInitEvents_multitouch(e)),$(this).on(e,function(t){console.log("cz:multitouch:on: ",e,t,arguments),this.touchEventManager.trigger.apply(this.touchEventManager,arguments)})
else{if("mouse"!=t)throw Error("CanvasZoomify: Unknown event `"+e+"`")
this.canvas.addEventListener(e,this._getInitEvents_mouse(e)),$(this).on(e,function(t){console.log("cz:mouse:on: ",e,t,arguments),this.$canvas.trigger.apply(this.$canvas,arguments)})}}.bind(this))},o.prototype._getInitEvents_custom=function(t){return function(e){var i=Array.prototype.slice.call(arguments,1)
i.unshift(e)
var s=o._getHandlerName(t),n=this.config[s]
if(n&&n.apply(this.config,i),!e.isDefaultPrevented()){var a=o._getDefaultHandlerName(t),h=this[a]
h&&h.apply(this,i)}}.bind(this)},o.prototype._getInitEvents_mouse=function(t){return function(e){var i=Array.prototype.slice.call(arguments,1),n=$.extend({},e,$.Event(t))
i.unshift(n)
var a=this.config[o._getHandlerName(t)]
if(a&&a.apply(this.config,i),n.isDefaultPrevented())return e.preventDefault(),s
var h=this[o._getDefaultHandlerName(t)]
h&&h.apply(this,i)}.bind(this)},o.prototype._getInitEvents_multitouch=function(t){return function(e){var i=Array.prototype.slice.call(arguments,1),n=$.extend({},e,$.Event(t))
i.unshift(n)
var a=this.config[o._getHandlerName(t)]
if(a&&a.apply(this.config,i),n.isDefaultPrevented())return e.preventDefault(),s
var h=this[o._getDefaultHandlerName(t)]
h&&h.apply(this,i)}.bind(this)},o.prototype.init=function(t){this._initEvents()},o.prototype.onCz_update_default=function(t){var e=_.findIndex(this.tileManager.levelValues,function(t){return t>=this.config.scale}.bind(this));-1==e&&(e=this.tileManager.levelValues.length-1),this.imageLevel=e,this.config.offsetX>this.canvas.width&&(this.config.offsetX=this.canvas.width),this.config.offsetY>this.canvas.height&&(this.config.offsetY=this.canvas.height)
var i=this.tileManager._tileWidthAtLevel[e],s=this.tileManager._tileHeightAtLevel[e]
if(-1!=i&&-1!=s){var o=-this.tileManager._tileWidthAtLevel[e]*this.tileManager._colsAtLevel[e],n=-this.tileManager._tileHeightAtLevel[e]*this.tileManager._rowsAtLevel[e]
this.config.offsetX<o&&(this.config.offsetX=o),this.config.offsetY<n&&(this.config.offsetY=n)}null!=this.config.scaleMax&&this.config.scale>this.config.scaleMax&&(this.config.scale=this.config.scaleMax),this.isDebug&&console.log("onCz_update_default: ",this.imageLevel,this.config.offsetX,this.config.offsetY,this.config.scaleMax)},o.prototype.onCz_clear_default=function(t){this.context.fillStyle="#fff",this.isDebug&&(console.log("onCz_clear_default"),this.context.strokeStyle="#ff0000"),this.context.save(),this.context.setTransform(1,0,0,1,0,0),this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.context.restore()},o.prototype.onCz_repaint_default=function(t){this.isDebug&&(console.log("onCz_repaint_default"),console.log(sprintf("Image Info: %s,%s,%s",this.config.offsetX,this.config.offsetY,this.config.scale)))
var e=this.imageLevel,i=this.config.scale/this.tileManager.levelValues[e]
this.tileManager.drawTileAtLevel(this.context,e,0,0,this.tileManager._rowsAtLevel[e],this.tileManager._colsAtLevel[e],this.config.offsetX,this.config.offsetY,i)},o.prototype.onPanstart_default=function(t){this.isDebug&&console.log("onPanstart_default")
var e=t.center,i=e.x,s=e.y
this.touchState.touchPanLastX=i,this.touchState.touchPanLastY=s},o.prototype.onPanmove_default=function(t){if("mouse"!=t.pointerType){var e=t.center,i=e.x,s=e.y
_.isNull(this.touchState.touchPanLastX)||_.isNull(this.touchState.touchPanLastY)||(this.config.offsetX+=i-this.touchState.touchPanLastX,this.config.offsetY+=s-this.touchState.touchPanLastY),this.touchState.touchPanLastX=i,this.touchState.touchPanLastY=s,this.trigger("cz_update"),this.trigger("cz_clear"),this.trigger("cz_repaint")}},o.prototype.onPinchstart_default=function(t){this.isDebug&&console.log("onPinchstart_default"),this.touchState.touchPinchLastScale=1},o.prototype.onPinch_default=function(t){var e=t.scale,i=e/this.touchState.touchPinchLastScale,s=100
if(i>1){var o=1+this.config.scaleStep*i/s
this.config.scale*=o,this.config.offsetX=Math.floor(this.config.offsetX*o),this.config.offsetY=Math.floor(this.config.offsetY*o)}else{var o=1+this.config.scaleStep/i/s
this.config.scale/=o,this.config.offsetX=Math.floor(this.config.offsetX/o),this.config.offsetY=Math.floor(this.config.offsetY/o)}this.isDebug&&console.log("onPinch_default: ",this.config.scale,this.config.offsetX,this.config.offsetY),this.trigger("cz_update"),this.trigger("cz_clear"),this.trigger("cz_repaint")},o.prototype.onMousedown_default=function(t){this.mouseState.isMouseDown=!0,this.mouseState.mouseMoveLastX=this._mousePosX(t),this.mouseState.mouseMoveLastY=this._mousePosY(t),this.isDebug&&console.log("onMousedown_default: ",this.mouseState)},o.prototype.onMouseup_default=function(t){this.mouseState.isMouseDown=!1,this.isDebug&&console.log("onMouseup_default: ",this.mouseState)},o.prototype.onMousemove_default=function(t){if(this.mouseState.isMouseDown){var e=this._mousePosX(t),i=this._mousePosY(t),s=this.config.offsetX+(e-this.mouseState.mouseMoveLastX),o=this.config.offsetY+(i-this.mouseState.mouseMoveLastY)
this.mouseState.mouseMoveLastX=e,this.mouseState.mouseMoveLastY=i,this.config.offsetX=s,this.config.offsetY=o,this.trigger("cz_update"),this.trigger("cz_clear"),this.trigger("cz_repaint"),this.isDebug&&console.log("onMousemove_default: ",this.mouseState)}},o.prototype.onMousewheel_default=function(t,e){var i=null
if(e?i=e:t.wheelDelta?i=-(t.wheelDelta/120):t.detail&&(i=t.detail/3),console.log("onMouseWheel_default: ",t),console.log("onMouseWheel_default: ",i),console.log("onMouseWheel_default: ",e),i){var s=this.config.scaleStep*Math.abs(i)
0>i?(this.config.scale*=s,this.config.offsetX=Math.floor(this.config.offsetX*s),this.config.offsetY=Math.floor(this.config.offsetY*s)):(this.config.scale/=s,this.config.offsetX=Math.floor(this.config.offsetX/s),this.config.offsetY=Math.floor(this.config.offsetY/s)),this.trigger("cz_update"),this.trigger("cz_clear"),this.trigger("cz_repaint")}t.preventDefault&&t.preventDefault(),t.returnValue=!1},o.prototype.onDOMMouseScroll=o.prototype.onMousewheel_default,"function"==typeof define&&define.amd?define(function(){return o}):"undefined"!=typeof module&&module.exports?module.exports=o:t[i]=o}(window,document,"CanvasZoomify")
